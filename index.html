<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MC Chat bot Pro</title>
<style>
  :root {
    --bg: #f6f7fb;
    --bot: #ffffff;
    --user: #0b84ff;
    --header: #183b56;
    --text: #333333;
    --shadow: rgba(0,0,0,0.1);
    --success: #1f7a3b;
    --warning: #f39c12;
    --error: #e74c3c;
    --typing: #3498db;
  }
  
  /* ‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶Æ‡ßã‡¶° ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ */
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #1a1a1a;
      --bot: #2d3748;
      --user: #2563eb;
      --header: #0f172a;
      --text: #e2e8f0;
      --shadow: rgba(0,0,0,0.3);
    }
  }

  [data-theme="dark"] {
    --bg: #1a1a1a;
    --bot: #2d3748;
    --user: #2563eb;
    --header: #0f172a;
    --text: #e2e8f0;
    --shadow: rgba(0,0,0,0.3);
  }

  [data-theme="light"] {
    --bg: #f6f7fb;
    --bot: #ffffff;
    --user: #0b84ff;
    --header: #183b56;
    --text: #333333;
    --shadow: rgba(0,0,0,0.1);
  }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
    transition: background 0.3s, color 0.3s;
  }

  header {
    background: var(--header);
    color: #fff;
    padding: 14px;
    text-align: center;
    font-weight: 700;
    font-size: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px var(--shadow);
  }

  .header-controls {
    display: flex;
    gap: 10px;
  }

  .theme-toggle, .clear-chat {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
  }

  #chat {
    flex: 1;
    overflow: auto;
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    scroll-behavior: smooth;
  }

  .msg {
    max-width: 82%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    animation: fadeIn 0.3s ease-in;
    box-shadow: 0 2px 4px var(--shadow);
    line-height: 1.4;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .bot {
    align-self: flex-start;
    background: var(--bot);
    color: var(--text);
    border-bottom-left-radius: 4px;
  }

  .user {
    align-self: flex-end;
    background: var(--user);
    color: #fff;
    border-bottom-right-radius: 4px;
  }

  .msg-time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 5px;
    text-align: right;
  }

  #bar {
    display: flex;
    gap: 8px;
    padding: 12px;
    background: var(--bot);
    align-items: center;
    border-top: 1px solid var(--shadow);
  }

  #text {
    flex: 1;
    padding: 12px 16px;
    border-radius: 24px;
    border: 1px solid #ddd;
    font-size: 16px;
    background: var(--bg);
    color: var(--text);
    transition: border 0.3s;
  }

  #text:focus {
    outline: none;
    border-color: var(--user);
    box-shadow: 0 0 0 2px rgba(11, 132, 255, 0.2);
  }

  button {
    padding: 10px 14px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    transition: transform 0.2s, background 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  button:hover {
    transform: scale(1.05);
  }

  button:active {
    transform: scale(0.95);
  }

  #send {
    background: var(--success);
    color: #fff;
  }

  #voice {
    background: var(--user);
    color: #fff;
  }  #thinking {
    font-style: italic;
    color: #666;
    padding: 6px 10px;
    border-radius: 10px;
    background: var(--bot);
    display: inline-block;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
  }

  .typing-indicator {
    display: flex;
    gap: 4px;
    padding: 10px 16px;
    background: var(--bot);
    border-radius: 18px;
    align-self: flex-start;
    max-width: 60px;
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--typing);
    animation: typingAnimation 1.4s infinite ease-in-out;
  }

  .typing-dot:nth-child(1) { animation-delay: -0.32s; }
  .typing-dot:nth-child(2) { animation-delay: -0.16s; }

  @keyframes typingAnimation {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }

  .small-note {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
    text-align: center;
    padding: 0 12px 8px;
  }

  .feedback-buttons {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    justify-content: flex-end;
  }

  .feedback-btn {
    background: transparent;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 4px 8px;
    font-size: 12px;
    color: #666;
  }

  .feedback-btn:hover {
    background: #f0f0f0;
    transform: none;
  }

  .suggestion-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }

  .suggestion-chip {
    background: var(--bot);
    border: 1px solid #ddd;
    border-radius: 16px;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .suggestion-chip:hover {
    background: #e9ecef;
  }

  .message-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .msg:hover .message-actions {
    opacity: 1;
  }

  .action-btn {
    background: transparent;
    border: none;
    color: #666;
    padding: 4px;
    font-size: 12px;
    border-radius: 4px;
  }

  .action-btn:hover {
    background: rgba(0,0,0,0.1);
  }

  .error-msg {
    background: #ffeaea;
    color: #d63031;
    border: 1px solid #ff7675;
  }

  .success-msg {
    background: #e8f6ef;
    color: #27ae60;
    border: 1px solid #58d68d;
  }

  /* ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶∞‡ßá‡¶∏‡ßç‡¶™‡¶®‡ßç‡¶∏‡¶ø‡¶≠ */
  @media (max-width: 768px) {
    .msg {
      max-width: 90%;
    }
    
    header {
      font-size: 18px;
      padding: 12px;
    }
    
    .header-controls button {
      padding: 5px 8px;
      font-size: 12px;
    }
  }

  /* ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤‡¶¨‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
  #chat::-webkit-scrollbar {
    width: 6px;
  }

  #chat::-webkit-scrollbar-track {
    background: transparent;
  }

  #chat::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
  }

  #chat::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
</style>
</head>
<body>
<header>
  <span>MC Chat bot Pro</span>
  <div class="header-controls">
    <button class="clear-chat" title="Clear chat">üóëÔ∏è</button>
    <button class="theme-toggle" title="Toggle theme">üåô</button>
  </div>
</header>

<div id="chat" role="log" aria-live="polite"></div>

<div id="bar">
  <input id="text" type="text" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®..." aria-label="Message input" />
  <button id="voice" title="Voice input">üéôÔ∏è</button>
  <button id="send" title="Send message">‚û§</button>
</div>
<div class="small-note">‡¶≠‡¶Ø‡¶º‡ßá‡¶∏: ‡¶¨‡¶≤‡¶≤‡ßá‡¶á ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá (‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø)‡•§ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶∏‡¶¨ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶π‡¶¨‡ßá‡•§</div><script>
/*
MC Chat bot Pro ‚Äî ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶ï‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü-‡¶∏‡¶æ‡¶á‡¶° ‡¶á‡¶Æ‡¶™‡ßç‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∂‡¶®
‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞:
- ‡¶°‡¶æ‡¶∞‡ßç‡¶ï/‡¶≤‡¶æ‡¶á‡¶ü ‡¶Æ‡ßã‡¶° ‡¶ü‡¶ó‡¶≤
- ‡¶ü‡¶æ‡¶á‡¶™‡¶ø‡¶Ç ‡¶á‡¶®‡ßç‡¶°‡¶ø‡¶ï‡ßá‡¶ü‡¶∞
- ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞
- ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™
- ‡¶´‡¶ø‡¶°‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ
- ‡¶∏‡¶æ‡¶ú‡ßá‡¶∂‡¶® ‡¶ö‡¶ø‡¶™‡¶∏
- ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® (‡¶ï‡¶™‡¶ø, ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞)
- ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶è‡¶∞‡¶∞ ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç
- ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡ßá‡¶≠
- ‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶Ö‡¶™‡ßç‡¶ü‡¶ø‡¶Æ‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®
*/

// DOM elements
const chat = document.getElementById('chat');
const text = document.getElementById('text');
const sendBtn = document.getElementById('send');
const voiceBtn = document.getElementById('voice');
const themeToggle = document.querySelector('.theme-toggle');
const clearChatBtn = document.querySelector('.clear-chat');

// State management
let followUpTopic = null;
let lastWikiTitle = null;
let isProcessing = false;
let chatHistory = [];

// Theme management
function initTheme() {
  const savedTheme = localStorage.getItem('chatbot-theme') || 
    (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  document.body.setAttribute('data-theme', savedTheme);
  updateThemeButton(savedTheme);
}

function toggleTheme() {
  const currentTheme = document.body.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  document.body.setAttribute('data-theme', newTheme);
  localStorage.setItem('chatbot-theme', newTheme);
  updateThemeButton(newTheme);
}

function updateThemeButton(theme) {
  themeToggle.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
}

// Load chat history from localStorage
function loadChatHistory() {
  try {
    const saved = localStorage.getItem('chatbot-history');
    if (saved) {
      chatHistory = JSON.parse(saved);
      renderChatHistory();
    }
  } catch (e) {
    console.error('Failed to load chat history:', e);
  }
}

// Save chat to localStorage
function saveChatToLocal() {
  try {
    localStorage.setItem('chatbot-history', JSON.stringify(chatHistory));
  } catch (e) {
    console.error('Failed to save chat history:', e);
  }
}

// Render chat history
function renderChatHistory() {
  chat.innerHTML = '';
  chatHistory.forEach(msg => {
    appendMessage(msg.text, msg.type, msg.timestamp, false);
  });
  scrollToBottom();
}

// Clear chat function
function clearChat() {
  if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
    chat.innerHTML = '';
    chatHistory = [];
    localStorage.removeItem('chatbot-history');
    appendMessage('‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶Æ‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?', 'bot');
  }
}

// Helper: format timestamp
function getCurrentTime() {
  const now = new Date();
  return now.toLocaleTimeString('bn-BD', { 
    hour: '2-digit', 
    minute: '2-digit',
    hour12: false 
  });
}

// Helper: append message with animation
function appendMessage(textContent, who, timestamp = null, saveToHistory = true) {
  const d = document.createElement('div');
  d.className = `msg ${who}`;
  
  const messageId = 'msg-' + Date.now();
  d.id = messageId;
  
  // Add message content
  const contentDiv = document.createElement('div');
  contentDiv.textContent = textContent;
  d.appendChild(contentDiv);
  
  // Add timestamp
  const timeDiv = document.createElement('div');
  timeDiv.className = 'msg-time';
  timeDiv.textContent = timestamp || getCurrentTime();
  d.appendChild(timeDiv);
  
  // Add message actions for user messages
  if (who === 'user') {
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'message-actions';
    
    const copyBtn = document.createElement('button');
    copyBtn.className = 'action-btn';
    copyBtn.textContent = '‡¶ï‡¶™‡¶ø';
    copyBtn.title = '‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®';
    copyBtn.onclick = () => copyToClipboard(textContent);
    
    actionsDiv.appendChild(copyBtn);
    d.appendChild(actionsDiv);
  }
  
  // Add feedback buttons for bot messages
  if (who === 'bot' && !textContent.includes('MC is thinking')) {
    const feedbackDiv = document.createElement('div');
    feedbackDiv.className = 'feedback-buttons';
    
    const helpfulBtn = document.createElement('button');
    helpfulBtn.className = 'feedback-btn';
    helpfulBtn.textContent = '‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶ï üëç';
    helpfulBtn.onclick = () => handleFeedback(messageId, 'helpful');
    
    const notHelpfulBtn = document.createElement('button');
    notHelpfulBtn.className = 'feedback-btn';
    notHelpfulBtn.textContent = '‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶ï ‡¶®‡¶Ø‡¶º üëé';
    notHelpfulBtn.onclick = () => handleFeedback(messageId, 'not_helpful');
    
    feedbackDiv.appendChild(helpfulBtn);
    feedbackDiv.appendChild(notHelpfulBtn);
    d.appendChild(feedbackDiv);
  }
  
  chat.appendChild(d);
  
  // Save to history if needed
  if (saveToHistory) {
    chatHistory.push({
      text: textContent,
      type: who,
      timestamp: timestamp || getCurrentTime()
    });
    saveChatToLocal();
  }
  
  scrollToBottom();
  return d;
}

// Copy to clipboard function
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    // Show temporary success message
    const originalColor = text.style.color;
    text.style.color = 'green';
    setTimeout(() => {
      text.style.color = originalColor;
    }, 1000);
  }).catch(err => {
    console.error('Failed to copy: ', err);
  });
}

// Handle user feedback
function handleFeedback(messageId, type) {
  const messageElement = document.getElementById(messageId);
  if (messageElement) {
    const feedbackDiv = messageElement.querySelector('.feedback-buttons');
    if (feedbackDiv) {
      feedbackDiv.innerHTML = type === 'helpful' 
        ? '<span style="color:green; font-size:12px;">‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶! üëç</span>' 
        : '<span style="color:red; font-size:12px;">‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶ üëé</span>';
      
      // Save feedback to localStorage
      try {
        const feedbacks = JSON.parse(localStorage.getItem('chatbot-feedbacks') || '[]');
        feedbacks.push({
          messageId,
          type,
          timestamp: Date.now()
        });
        localStorage.setItem('chatbot-feedbacks', JSON.stringify(feedbacks));
      } catch (e) {
        console.error('Failed to save feedback:', e);
      }
    }
  }
}

// Scroll to bottom of chat
function scrollToBottom() {
  chat.scrollTop = chat.scrollHeight;
}

// Show typing indicator
function showTypingIndicator() {
  const indicator = document.createElement('div');
  indicator.className = 'typing-indicator';
  indicator.id = 'typing-indicator';
  
  for (let i = 0; i < 3; i++) {
    const dot = document.createElement('div');
    dot.className = 'typing-dot';
    indicator.appendChild(dot);
  }
  
  chat.appendChild(indicator);
  scrollToBottom();
  return indicator;
}

// Hide typing indicator
function hideTypingIndicator() {
  const indicator = document.getElementById('typing-indicator');
  if (indicator) {
    indicator.remove();
  }
}

// Show thinking message
function showThinking() {
  const thinking = document.createElement('div');
  thinking.className = 'msg bot';
  thinking.id = 'thinking';
  thinking.textContent = 'MC is thinking...';
  chat.appendChild(thinking);
  scrollToBottom();
  return thinking;
}

// Show suggestion chips
function showSuggestions(suggestions) {
  const suggestionDiv = document.createElement('div');
  suggestionDiv.className = 'suggestion-chips';
  
  suggestions.forEach(suggestion => {
    const chip = document.createElement('div');
    chip.className = 'suggestion-chip';
    chip.textContent = suggestion;
    chip.onclick = () => {
      handleSuggestionClick(suggestion);
    };
    suggestionDiv.appendChild(chip);
  });
  
  chat.appendChild(suggestionDiv);
  scrollToBottom();
}

// Handle suggestion clicks with proper responses
function handleSuggestionClick(suggestion) {
  const responses = {
    '‡¶ó‡¶£‡¶ø‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ': '‡¶ó‡¶£‡¶ø‡¶§‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶ø ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®:\n\n‚Ä¢ ‡ß®+‡ß®\n‚Ä¢ ‡ß´‡ß¶*‡ß©/‡ß®\n‚Ä¢ (‡ßß‡ß¶+‡ß´)*‡ß®\n‚Ä¢ ‡ß®‡ß´% ‡¶Ö‡¶´ ‡ß®‡ß¶‡ß¶\n\n‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßã‡¶® ‡¶ó‡¶£‡¶ø‡¶§‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?',
    '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá': '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶¶‡¶ï‡ßç‡¶∑‡¶ø‡¶£ ‡¶è‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶â‡¶®‡ßç‡¶®‡¶Ø‡¶º‡¶®‡¶∂‡ßÄ‡¶≤ ‡¶¶‡ßá‡¶∂‡•§ ‡¶∞‡¶æ‡¶ú‡¶ß‡¶æ‡¶®‡ßÄ ‡¶¢‡¶æ‡¶ï‡¶æ, ‡¶Æ‡ßÅ‡¶¶‡ßç‡¶∞‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ, ‡¶è‡¶¨‡¶Ç ‡¶∞‡¶æ‡¶∑‡ßç‡¶ü‡ßç‡¶∞‡¶≠‡¶æ‡¶∑‡¶æ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡•§ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶ú‡¶®‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶™‡ßç‡¶∞‡¶æ‡¶Ø‡¶º ‡ßß‡ß≠ ‡¶ï‡ßã‡¶ü‡¶ø‡•§ ‡¶è‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡ßá‡¶∞ ‡¶∏‡¶¨‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶ò‡¶®‡¶¨‡¶∏‡¶§‡¶ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶¶‡ßá‡¶∂‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø‡•§ ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶®‡¶¶‡ßÄ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶π‡¶≤‡ßã ‡¶™‡¶¶‡ßç‡¶Æ‡¶æ, ‡¶Æ‡ßá‡¶ò‡¶®‡¶æ, ‡¶è‡¶¨‡¶Ç ‡¶Ø‡¶Æ‡ßÅ‡¶®‡¶æ‡•§',
    '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®': '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶π‡¶≤‡ßã ‡¶™‡ßç‡¶∞‡¶æ‡¶ï‡ßÉ‡¶§‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡ßá‡¶∞ ‡¶ó‡¶†‡¶® ‡¶ì ‡¶Ü‡¶ö‡¶∞‡¶£ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶ú‡ßç‡¶û‡¶æ‡¶®‡ßá‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø‡¶ó‡¶§ ‡¶â‡¶¶‡ßç‡¶Ø‡ßã‡¶ó‡•§ ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶∂‡¶æ‡¶ñ‡¶æ‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∞‡¶Ø‡¶º‡ßá‡¶õ‡ßá:\n\n‚Ä¢ ‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ\n‚Ä¢ ‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®\n‚Ä¢ ‡¶ú‡ßÄ‡¶¨‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®\n‚Ä¢ ‡¶ú‡ßç‡¶Ø‡ßã‡¶§‡¶ø‡¶∞‡ßç‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ\n‚Ä¢ ‡¶≠‡ßÇ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®\n\n‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßã‡¶® ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá ‡¶ú‡¶æ‡¶®‡¶§‡ßá ‡¶ö‡¶æ‡¶®?',
    '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏': '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶π‡¶≤‡ßã ‡¶Ö‡¶§‡ßÄ‡¶§ ‡¶ò‡¶ü‡¶®‡¶æ‡¶¨‡¶≤‡¶ø‡¶∞ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶Ø‡¶º‡¶®‡•§ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶∏‡¶Æ‡ßÉ‡¶¶‡ßç‡¶ß, ‡¶Ø‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∞‡¶Ø‡¶º‡ßá‡¶õ‡ßá:\n\n‚Ä¢ ‡¶™‡ßç‡¶∞‡¶æ‡¶ö‡ßÄ‡¶® ‡¶¨‡¶ô‡ßç‡¶ó ‡¶∞‡¶æ‡¶ú‡ßç‡¶Ø\n‚Ä¢ ‡¶Æ‡ßÅ‡¶ò‡¶≤ ‡¶∂‡¶æ‡¶∏‡¶®\n‚Ä¢ ‡¶¨‡ßç‡¶∞‡¶ø‡¶ü‡¶ø‡¶∂ÊÆñÊ∞ë\n‚Ä¢ ‡¶≠‡¶æ‡¶∑‡¶æ ‡¶Ü‡¶®‡ßç‡¶¶‡ßã‡¶≤‡¶® ‡ßß‡ßØ‡ß´‡ß®\n‚Ä¢ ‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§‡¶ø‡¶Ø‡ßÅ‡¶¶‡ßç‡¶ß ‡ßß‡ßØ‡ß≠‡ßß\n\n‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßã‡¶® ‡¶∏‡¶Æ‡¶Ø‡¶º‡¶ï‡¶æ‡¶≤ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶ú‡¶æ‡¶®‡¶§‡ßá ‡¶ö‡¶æ‡¶®?',
    '‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø': '‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø ‡¶π‡¶≤‡ßã ‡¶¨‡ßà‡¶ú‡ßç‡¶û‡¶æ‡¶®‡¶ø‡¶ï ‡¶ú‡ßç‡¶û‡¶æ‡¶®‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó‡•§ ‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∞‡¶Ø‡¶º‡ßá‡¶õ‡ßá:\n\n‚Ä¢ ‡¶ï‡ßÉ‡¶§‡ßç‡¶∞‡¶ø‡¶Æ ‡¶¨‡ßÅ‡¶¶‡ßç‡¶ß‡¶ø‡¶Æ‡¶§‡ßç‡¶§‡¶æ (AI)\n‚Ä¢ ‡¶Æ‡ßá‡¶∂‡¶ø‡¶® ‡¶≤‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç\n‚Ä¢ ‡¶¨‡ßç‡¶≤‡¶ï‡¶ö‡ßá‡¶á‡¶®\n‚Ä¢ ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶ø‡¶Ç\n‚Ä¢ IoT (‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶Ö‡¶´ ‡¶•‡¶ø‡¶Ç‡¶∏)\n\n‡¶ï‡ßã‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶ú‡¶æ‡¶®‡¶§‡ßá ‡¶ö‡¶æ‡¶®?',
    '‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®': '‡¶Ü‡¶Æ‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?\n\n‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶ú‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶∏‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®:\n‚Ä¢ ‡¶ó‡¶£‡¶ø‡¶§‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®\n‚Ä¢ ‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá ‡¶§‡¶•‡ßç‡¶Ø\n‚Ä¢ ‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶\n‚Ä¢ ‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®\n\n‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶¨‡¶æ ‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®!',
    '‡¶Ö‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá ‡¶ú‡¶æ‡¶®‡¶§‡ßá ‡¶ö‡¶æ‡¶®': '‡¶Ü‡¶™‡¶®‡¶ø ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶ú‡¶æ‡¶®‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®:\n\n‚Ä¢ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶® ‡¶ì ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø\n‚Ä¢ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ì ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡ßÉ‡¶§‡¶ø\n‚Ä¢ ‡¶ó‡¶£‡¶ø‡¶§ ‡¶ì ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø\n‚Ä¢ ‡¶≠‡ßÇ‡¶ó‡ßã‡¶≤ ‡¶ì ‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂\n‚Ä¢ ‡¶∏‡¶æ‡¶π‡¶ø‡¶§‡ßç‡¶Ø ‡¶ì ‡¶∂‡¶ø‡¶≤‡ßç‡¶™\n\n‡¶ï‡ßã‡¶® ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá ‡¶Ü‡¶ó‡ßç‡¶∞‡¶π‡ßÄ?'
  };

  // Show user's selection
  appendMessage(suggestion, 'user');
  
  showTypingIndicator();
  
  setTimeout(() => {
    hideTypingIndicator();
    
    if (responses[suggestion]) {
      appendMessage(responses[suggestion], 'bot');
    } else {
      appendMessage('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶Ü‡¶∞‡¶ì ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¨‡¶≤‡ßÅ‡¶®‡•§', 'bot');
    }
  }, 800);
}// Safe math evaluator
function tryMathEval(input) {
  // ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø‡¶§‡ßá ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞
  const normalizedInput = input.replace(/[‡ß¶-‡ßØ]/g, d => '‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ'.indexOf(d));
  
  // ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶ó‡¶æ‡¶£‡¶ø‡¶§‡¶ø‡¶ï ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞
  const bengaliToEnglish = {
    '‡¶ú‡¶°‡¶º': '+', '‡¶Ø‡ßã‡¶ó': '+', '‡¶™‡ßç‡¶≤‡¶æ‡¶∏': '+',
    '‡¶¨‡¶ø‡¶Ø‡¶º‡ßã‡¶ó': '-', '‡¶Æ‡¶æ‡¶á‡¶®‡¶æ‡¶∏': '-',
    '‡¶ó‡ßÅ‡¶£': '*', 'into': '*', 'into': '*',
    '‡¶≠‡¶æ‡¶ó': '/', 'by': '/',
    '‡¶∂‡¶§‡¶æ‡¶Ç‡¶∂': '%', 'percent': '%',
    '‡¶ò‡¶æ‡¶§': '**', 'power': '**'
  };
  
  let expr = normalizedInput.toLowerCase();
  Object.keys(bengaliToEnglish).forEach(key => {
    expr = expr.replace(new RegExp(key, 'g'), bengaliToEnglish[key]);
  });
  
  // Allow digits, spaces, parentheses, + - * / % . ^ 
  const safe = expr.replace(/[^0-9+\-*/(). %^]/g, '');
  if (!/[\d]/.test(safe)) return null;
  
  const finalExpr = safe.replace(/\^/g, '**').replace(/%/g, '/100');
  
  // Final safety check
  if (!/^[0-9+\-*/().\s%*^]+$/.test(finalExpr)) return null;
  
  try {
    const result = Function('"use strict"; return (' + finalExpr + ');')();
    if (result === undefined || !isFinite(result)) return null;
    return String(result);
  } catch (e) {
    return null;
  }
}

// Wikipedia summary fetch (bn first, en fallback)
async function fetchWikiSummary(title) {
  // Try Bengali REST summary
  const bnUrl = 'https://bn.wikipedia.org/api/rest_v1/page/summary/' + encodeURIComponent(title);
  try {
    const r1 = await fetch(bnUrl);
    if (r1.ok) {
      const j = await r1.json();
      if (j.extract) return { title: j.title, extract: j.extract, lang: 'bn' };
    }
  } catch (e) { }
  
  // Fallback English
  const enUrl = 'https://en.wikipedia.org/api/rest_v1/page/summary/' + encodeURIComponent(title);
  try {
    const r2 = await fetch(enUrl);
    if (r2.ok) {
      const j2 = await r2.json();
      if (j2.extract) return { title: j2.title, extract: j2.extract, lang: 'en' };
    }
  } catch (e) { }
  
  return null;
}

// Wikipedia deep extract using MediaWiki API
async function fetchWikiDeep(title) {
  const url = 'https://en.wikipedia.org/w/api.php?action=query&prop=extracts&explaintext&format=json&titles=' + 
    encodeURIComponent(title) + '&origin=*';
  try {
    const r = await fetch(url);
    if (!r.ok) return null;
    const j = await r.json();
    const pages = j.query && j.query.pages;
    if (!pages) return null;
    const p = Object.values(pages)[0];
    if (p && p.extract) return p.extract;
    return null;
  } catch (e) { return null; }
}

// Translate English->Bengali via MyMemory API
async function translateToBengali(text) {
  try {
    const url = 'https://api.mymemory.translated.net/get?q=' + encodeURIComponent(text) + '&langpair=en|bn';
    const r = await fetch(url);
    if (!r.ok) return null;
    const j = await r.json();
    if (j && j.responseData && j.responseData.translatedText) {
      return j.responseData.translatedText;
    }
    return null;
  } catch (e) { return null; }
}

// Main bot logic
async function handleUser(raw) {
  if (isProcessing) return;
  
  const userText = raw.trim();
  if (!userText) return;

  // Show user's message
  appendMessage(userText, 'user');
  isProcessing = true;

  // Check math first
  const mathResult = tryMathEval(userText);
  if (mathResult !== null) {
    showTypingIndicator();
    await new Promise(r => setTimeout(r, 800));
    hideTypingIndicator();
    appendMessage('‡¶ó‡¶£‡¶ø‡¶§‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞: ' + mathResult, 'bot');
    isProcessing = false;
    return;
  }

  // Lowercase analyze
  const lc = userText.toLowerCase();

  // Casual greetings (Bangla / Banglish / English)
  const greetings = ['hi', 'hello', 'hey', '‡¶π‡¶æ‡¶á', '‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã', '‡¶π‡ßá‡¶á', '‡¶®‡¶Æ‡¶∏‡ßç‡¶ï‡¶æ‡¶∞', '‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ'];
  for (const g of greetings) {
    if (lc.includes(g)) {
      showTypingIndicator();
      await new Promise(r => setTimeout(r, 600));
      hideTypingIndicator();
      appendMessage('‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! ‡¶Ü‡¶Æ‡¶ø ‡¶ï‡ßá‡¶Æ‡¶®‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?', 'bot');
      
      // Show suggestions after greeting
      setTimeout(() => {
        showSuggestions(['‡¶ó‡¶£‡¶ø‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ', '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá', '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®', '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏']);
      }, 300);
      
      isProcessing = false;
      return;
    }
  }

  // Personal Q check
  const personalKeys = [
    {
      k: ['who made you', 'who is your creator', 'who created you', '‡¶ï‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá', '‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶ï‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá', '‡¶ï‡ßá ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá'],
      ans: '‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá Abir ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§'
    },
    {
      k: ['what is your name', '‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ï‡¶ø', '‡¶§umar naam ki', 'tomar naam ki', '‡¶§umi ke', '‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶Ø‡¶º ‡¶ï‡¶ø'],
      ans: '‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ MC Chat bot Pro‡•§ ‡¶Ü‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü‡•§'
    },
    {
      k: ['how are you', '‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ', '‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßã', '‡¶ï‡¶ø ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ'],
      ans: '‡¶Ü‡¶Æ‡¶ø ‡¶≠‡¶æ‡¶≤‡ßã ‡¶Ü‡¶õ‡¶ø, ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßá‡¶®?'
    }
  ];
  
  for (const pk of personalKeys) {
    for (const patt of pk.k) {
      if (lc.includes(patt)) {
        showTypingIndicator();
        await new Promise(r => setTimeout(r, 500));
        hideTypingIndicator();
        appendMessage(pk.ans, 'bot');
        isProcessing = false;
        return;
      }
    }
  }

  // If user answers yes/no as follow-up
  if (followUpTopic) {
    if (lc === 'yes' || lc === 'y' || lc.includes('yes') || lc.includes('‡¶π‡ßç‡¶Ø‡¶æ‡¶Å') || lc.includes('‡¶π‡ßç‡¶Ø‡¶æ') || lc.includes('‡¶ú‡¶ø')) {
      showTypingIndicator();
      const deepEn = await fetchWikiDeep(followUpTopic);
      let finalText = null;
      
      if (deepEn) {
        const tr = await translateToBengali(deepEn.slice(0, 3000));
        finalText = tr || deepEn;
      } else {
        finalText = '‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§';
      }
      
      await new Promise(r => setTimeout(r, 800));
      hideTypingIndicator();
      appendMessage(finalText, 'bot');
      followUpTopic = null;
      isProcessing = false;
      return;
    }
    
    if (lc === 'no' || lc === 'n' || lc.includes('no') || lc.includes('‡¶®‡¶æ')) {
      showTypingIndicator();
      await new Promise(r => setTimeout(r, 400));
      hideTypingIndicator();
      appendMessage('‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶ú‡¶æ‡¶®‡¶§‡ßá ‡¶ö‡¶æ‡¶ì?', 'bot');
      followUpTopic = null;
      isProcessing = false;
      return;
    }
  }

  // Otherwise, try Wikipedia summary
  showTypingIndicator();
  const wiki = await fetchWikiSummary(userText);
  await new Promise(r => setTimeout(r, 800));
  hideTypingIndicator();

  if (wiki) {
    let out = wiki.extract;
    
    // If page is English, translate to Bengali
    if (wiki.lang === 'en') {
      const tr = await translateToBengali(out.slice(0, 2000));
      if (tr) out = tr;
    }
    
    appendMessage(out, 'bot');
    
    // Set followUpTopic for deep follow-up
    followUpTopic = wiki.title;
    
    // Ask for follow up in Bengali
    appendMessage('‡¶Ü‡¶∞‡¶ì ‡¶ú‡¶æ‡¶®‡¶§‡ßá ‡¶ö‡¶æ‡¶ì? (‡¶π‡ßç‡¶Ø‡¶æ‡¶Å/‡¶®‡¶æ)', 'bot');
    isProcessing = false;
    return;
  }

  // Fallback: couldn't find wiki
  showTypingIndicator();
  await new Promise(r => setTimeout(r, 500));
  hideTypingIndicator();
  
  appendMessage('‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶∏‡¶†‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ñ‡¶®‡ßã ‡¶™‡¶æ‡¶ö‡ßç‡¶õ‡¶ø ‡¶®‡¶æ‡•§ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≠‡¶ø‡¶®‡ßç‡¶®‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶¨‡¶≤‡ßã ‡¶¨‡¶æ ‡¶Ü‡¶∞‡¶ì ‡¶¨‡¶ø‡¶∂‡¶¶ ‡¶ú‡¶æ‡¶®‡¶æ‡¶ì‡•§', 'bot');
  
  // Show suggestions for fallback
  setTimeout(() => {
    showSuggestions(['‡¶ó‡¶£‡¶ø‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶¶‡¶ø‡¶®', '‡¶Ö‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá ‡¶ú‡¶æ‡¶®‡¶§‡ßá ‡¶ö‡¶æ‡¶®', '‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®']);
  }, 300);
  
  isProcessing = false;
}

// Send button handler
sendBtn.onclick = () => {
  const v = text.value.trim();
  if (!v) return;
  text.value = '';
  text.focus();
  handleUser(v);
};

// Enter key handler
text.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendBtn.click();
});

// Voice recognition setup
let recog;
let isListening = false;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  recog = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recog.lang = 'en-US';
  recog.interimResults = false;
  recog.continuous = false;

  recog.onstart = () => {
    isListening = true;
    voiceBtn.textContent = 'üî¥';
    voiceBtn.style.background = 'var(--error)';
  };
  
  recog.onend = () => {
    isListening = false;
    voiceBtn.textContent = 'üéôÔ∏è';
    voiceBtn.style.background = '';
  };
  
  recog.onerror = (ev) => {
    isListening = false;
    voiceBtn.textContent = 'üéôÔ∏è';
    voiceBtn.style.background = '';
    appendMessage('‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + (ev.error || ''), 'bot');
  };

  recog.onresult = (ev) => {
    const spoken = ev.results[0][0].transcript;
    text.value = spoken;
    sendBtn.click();
  };

  voiceBtn.onclick = () => {
    if (!isListening) {
      try {
        recog.start();
      } catch (e) {
        appendMessage('‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∞‡¶ø‡¶ï‡¶ó‡¶®‡¶ø‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§', 'bot');
      }
    } else {
      try {
        recog.stop();
      } catch (e) { }
    }
  };
} else {
  voiceBtn.disabled = true;
  voiceBtn.textContent = 'üéôÔ∏è';
  voiceBtn.title = 'Voice not supported';
}

// Theme toggle
themeToggle.onclick = toggleTheme;

// Clear chat
clearChatBtn.onclick = clearChat;

// Initialization
window.addEventListener('load', () => {
  initTheme();
  loadChatHistory();
  
  // Show welcome message if no history
  if (chatHistory.length === 0) {
    setTimeout(() => {
      appendMessage('‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! ‡¶Ü‡¶Æ‡¶ø MC Chat bot Pro ‚Äî ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?', 'bot');
      
      // Show initial suggestions
      setTimeout(() => {
        showSuggestions(['‡¶ó‡¶£‡¶ø‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ', '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá', '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®', '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏', '‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø']);
      }, 500);
    }, 300);
  }
});

// Auto-resize textarea (if we change to textarea in future)
text.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
});
</script>
</body>
</html>